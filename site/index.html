<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema Petrobras - Quest√µes & Flashcards</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { 
        --primary:#2c3e50; --sec:#3498db; --acc:#e74c3c; --succ:#27ae60; --bg:#f4f4f9; 
        --light: #ecf0f1; --text-muted: #95a5a6; --purple: #8e44ad; --orange: #f39c12;
    }
    body{font-family:'Segoe UI',sans-serif;margin:0;background:var(--bg);color:#333;line-height:1.5}
    .container{max-width:1300px;margin:0 auto;padding:20px} .flex{display:flex;justify-content:space-between;align-items:center}
    
    /* Header */
    header{background:var(--primary);color:#fff;padding:1rem 0;box-shadow:0 2px 5px rgba(0,0,0,.1); transition:.3s; z-index:10} 
    header h4{margin:0; font-weight:600; font-size:1.5rem; transition:.3s}
    header.sticky{position:fixed;top:0;width:100%;padding:.5rem 0;box-shadow:0 4px 10px rgba(0,0,0,.2)}
    header.sticky h4{font-size:1.2rem}
    body.header-espaco { padding-top: 70px; } 
    
    /* Navega√ß√£o */
    nav button{background:transparent;border:1px solid rgba(255,255,255,.5);color:#fff;padding:6px 12px;margin-left:5px;border-radius:4px;cursor:pointer;font-size:.85rem; transition:.3s}
    nav button:hover, nav button.ativa{background:var(--sec);border-color:var(--sec);color:#fff}
    #nav-importar { background: var(--purple); border-color: var(--purple); }
    #nav-importar:hover { background: #9b59b6; }
    #nav-flashcards { background: var(--orange); border-color: var(--orange); }
    #nav-flashcards:hover { background: #e67e22; }

    /* Se√ß√µes e Forms */
    .secao{background:#fff;padding:25px;border-radius:8px;margin-top:20px;display:none;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    input,select,textarea{width:100%;padding:8px;margin:5px 0;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}
    .toolbar{display:flex;gap:5px;background:#eee;padding:5px;border:1px solid #ccc;border-bottom:0;border-radius:4px 4px 0 0}
    .btn-tool{cursor:pointer;padding:2px 8px;font-weight:bold; background:#fff; border:1px solid #ccc; border-radius:4px; min-width: 30px;}
    .input-com-toolbar { margin-top: 0 !important; border-top-left-radius: 0; border-top-right-radius: 0; }
    .btn-acao{background:var(--succ);color:#fff;border:none;padding:10px;width:100%;border-radius:4px;cursor:pointer;font-weight:bold;margin-top:10px}
    
    /* Imagens */
    .questao-img { max-width: 100%; max-height: 300px; display: block; margin: 10px auto; border-radius: 4px; border: 1px solid #ddd; }
    .img-preview-mini { max-width: 100px; max-height: 100px; display: block; margin-top: 5px; border: 1px solid #ccc; }

    /* Tabela */
    table{width:100%;border-collapse:collapse;margin-top:15px;font-size:.85em;table-layout:fixed}
    th,td{padding:6px 8px;border-bottom:1px solid #eee;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;text-align:left}
    th{background:var(--primary);color:#fff;cursor:pointer; position:sticky; top:0} td:last-child{overflow:visible}
    .btn-icon{background:none;border:none;cursor:pointer;font-size:1.2em; opacity:.8} .btn-icon:hover{opacity:1}
    .dots{letter-spacing:2px} .color-facil{color:#27ae60} .color-medio{color:#f39c12} .color-dificil{color:#e74c3c}

    /* Modal */
    .modal{display:none;position:fixed;z-index:999;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5)}
    .modal-content{background:#fff;margin:5% auto;padding:20px;width:95%;max-width:800px;border-radius:8px}
    .filtro-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px}
    .input-group{display:flex;align-items:center} .input-group span{width:25px;font-weight:bold}
    
    /* Importa√ß√£o Styles */
    .imp-row { display: flex; gap: 10px; align-items: flex-start; background: #fff; padding: 10px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 4px; transition: 0.3s; }
    .imp-row.ja-cadastrada { border-left: 4px solid #e74c3c; background: #fff5f5; }
    .imp-row.sucesso-salvo { border-left: 4px solid #27ae60; background: #eafaf1; }
    .imp-meta { min-width: 150px; max-width: 150px; display: flex; flex-direction: column; gap: 5px; }
    .imp-content { flex-grow: 1; }
    .imp-gab { min-width: 60px; max-width: 60px; text-align: center; }
    .imp-acoes { min-width: 60px; text-align: center; display: flex; flex-direction: column; gap: 5px; align-items: center; justify-content: center; }
    .imp-textarea { width: 100%; border: 1px solid #eee; resize: vertical; font-family: inherit; font-size: 0.9rem; padding: 5px; border-radius: 4px;}
    .imp-textarea:focus { border-color: var(--sec); outline: none; }
    .preview-header { display: flex; background: var(--primary); color: white; padding: 10px; border-radius: 4px 4px 0 0; font-weight: bold; font-size: 0.85rem;}
    .aviso-dup { color:#e74c3c; font-weight:bold; font-size:0.8em; display:block; margin-top:2px; }
    
    /* Toolbar Flutuante */
    .floating-toolbar { position: absolute; display: none; background: #333; padding: 5px 10px; border-radius: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; gap: 5px; }
    .floating-toolbar button { background: #555; border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .floating-toolbar button:hover { background: #777; }

    /* Renderiza√ß√£o HTML */
    .render-html b { font-weight: 900; }
    .render-html u { text-decoration: underline; }
    .render-html i { font-style: italic; }
    .render-html mark { background-color: #f1c40f; color: #000; padding: 0 2px; }

    /* Flashcards */
    .fc-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
    .fc-lista { border: 1px solid #eee; max-height: 500px; overflow-y: auto; background: #fafafa; border-radius: 8px; padding: 10px; }
    .fc-item-lista { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
    .flip-card-container { perspective: 1000px; width: 100%; height: 350px; margin: 20px auto; max-width: 600px; cursor: pointer; }
    .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .flip-card-container.virado .flip-card-inner { transform: rotateY(180deg); }
    .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; font-size: 1.2rem; }
    .flip-card-front { background-color: #fff; color: #333; border: 2px solid #eee; }
    .flip-card-back { background-color: var(--sec); color: white; transform: rotateY(180deg); border: 2px solid var(--sec); }
    .fc-botoes-resposta { display: flex; justify-content: center; gap: 15px; margin-top: 20px; opacity: 0; pointer-events: none; transition: 0.3s; }
    .fc-botoes-resposta.visivel { opacity: 1; pointer-events: all; }

    /* Loader */
    #loader-overlay { display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background:rgba(255,255,255,0.9); justify-content:center; align-items:center; flex-direction:column; }
    .spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--sec); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Drag Drop */
    #area-drop { transition: all 0.3s ease; border: 2px solid transparent; }
    #area-drop.drag-over { background-color: #e8f6f3 !important; border: 2px dashed #27ae60 !important; transform: scale(1.02); }
    #msg-drop { pointer-events: none; font-weight: bold; color: #27ae60; display: none; }
    #area-drop.drag-over #msg-drop { display: block; }
  </style>
</head>
<body>
<div id="loader-overlay"><div class="spinner"></div><div id="loader-msg">Processando...</div></div>

<header id="main-header"><div class="container flex"><div class="logo"><h4>Concurso Petrobras</h4></div>
<nav>
  <button id="nav-cadastro" onclick="nav('cadastro')">Cadastrar</button>
  <button id="nav-banco" onclick="nav('banco')">Banco</button>
  <button id="nav-praticar" onclick="nav('praticar')">Praticar</button>
  <button id="nav-prova" onclick="nav('prova')" style="color:#f1c40f;border-color:#f1c40f">Simulado Real</button>
  <button id="nav-flashcards" onclick="nav('flashcards')">üóÇÔ∏è Flashcards</button>
  <button id="nav-estatisticas" onclick="nav('estatisticas')">Estat√≠sticas</button>
  <button id="nav-config" onclick="nav('config')">‚öôÔ∏è Config</button>
  <button id="nav-importar" onclick="nav('importar')">üìÇ Importar PDF</button>
</nav></div></header>

<div id="floating-toolbar" class="floating-toolbar">
    <button onmousedown="event.preventDefault(); fmtUlt('b')" title="Negrito">B</button>
    <button onmousedown="event.preventDefault(); fmtUlt('i')" title="It√°lico">I</button>
    <button onmousedown="event.preventDefault(); fmtUlt('u')" title="Sublinhado">U</button>
    <button onmousedown="event.preventDefault(); fmtUlt('mark')" title="Destaque">üñç</button>
</div>

<section id="secao-cadastro" class="secao"><div class="container" style="max-width:900px">
  <h2>Cadastrar Quest√£o</h2><form id="form-cadastro">
  <label>Enunciado:</label><textarea id="cad-enunciado" class="input-com-toolbar" rows="4" required onfocus="showToolbar(this)"></textarea>
  <label>Imagem (Opcional):</label><input type="file" id="cad-imagem" accept="image/*">
  <div class="filtro-grid"><select id="cad-banca" required></select><select id="cad-instituicao"><option value="">Institui√ß√£o...</option></select><input type="number" id="cad-ano" placeholder="Ano"><select id="cad-disciplina" required onchange="carregarAssuntos('cad')"></select></div>
  <div class="filtro-grid"><select id="cad-assunto" required></select><select id="cad-dificuldade"><option>F√°cil</option><option>M√©dio</option><option>Dif√≠cil</option></select></div>
  <select id="cad-tipo" onchange="altTipo('cad')"><option value="ME">M√∫ltipla Escolha</option><option value="CE">Certo/Errado</option></select>
  <div id="cad-container-alt">
    <div class="input-group"><span>A)</span><input type="text" id="cad-alt-a" onfocus="showToolbar(this)"></div>
    <div class="input-group"><span>B)</span><input type="text" id="cad-alt-b" onfocus="showToolbar(this)"></div>
    <div class="input-group"><span>C)</span><input type="text" id="cad-alt-c" onfocus="showToolbar(this)"></div>
    <div class="input-group"><span>D)</span><input type="text" id="cad-alt-d" onfocus="showToolbar(this)"></div>
    <div class="input-group"><span>E)</span><input type="text" id="cad-alt-e" onfocus="showToolbar(this)"></div>
  </div>
  <label>Gabarito:</label><select id="cad-gabarito" required></select><button type="submit" class="btn-acao">Salvar</button>
  </form>
</div></section>

<section id="secao-importar" class="secao">
    <div class="container">
        <h2>Importar de PDF</h2>
        <div id="area-drop" class="filtro-grid" style="background:#f9f9f9; padding:25px; border-radius:6px; margin-bottom:20px; position:relative;">
            <div id="msg-drop" style="position:absolute; top:-15px; left:50%; transform:translateX(-50%); background:#27ae60; color:white; padding:2px 10px; border-radius:4px; font-size:0.8rem;">Solte o arquivo aqui!</div>
            <div style="grid-column: span 2; display: flex; gap: 10px; align-items: center;">
                <input type="file" id="imp-file" accept="application/pdf" style="background:#fff; width:100%">
                <button class="btn-acao" onclick="lerPDF()" style="margin:5px 0; width:150px; background:#27ae60">Ler PDF</button>
            </div>
            <select id="imp-disciplina" onchange="carregarAssuntos('imp')"></select>
            <select id="imp-assunto"><option value="">Assunto Global...</option></select>
        </div>
        <div id="imp-preview-container" style="display:none">
            <h3 id="imp-titulo-preview">Pr√©via</h3>
            <button class="btn-acao" onclick="salvarLote()" style="margin-bottom:15px;">üíæ Salvar Todas no Banco</button>
            <div class="preview-header">
                <div style="width:40px">#</div><div style="width:150px; margin-right:10px">Banca/Ano</div>
                <div style="flex-grow:1">Enunciado / Alternativas (Edit√°vel)</div><div style="width:60px; text-align:center">Gab</div><div style="width:60px; text-align:center">A√ß√µes</div>
            </div>
            <div id="imp-lista-questoes" style="background:#f4f4f9; padding:10px; max-height:600px; overflow-y:auto; border:1px solid #ccc"></div>
        </div>
    </div>
</section>

<section id="secao-banco" class="secao"><div class="container"><div class="flex"><h2>Banco de Quest√µes</h2><span id="total-db" style="color:#777"></span></div><div class="filtro-grid" style="background:#f9f9f9;padding:10px;border-radius:6px"><input type="text" id="busca-texto" placeholder="Buscar..." onkeyup="filtrar()"><select id="busca-disciplina" onchange="carregarAssuntos('busca'); filtrar()"></select><select id="busca-assunto" onchange="filtrar()"><option value="">Todos Assuntos</option></select><select id="busca-banca" onchange="filtrar()"></select><select id="busca-dificuldade" onchange="filtrar()"><option value="">Dif.</option><option>F√°cil</option><option>M√©dio</option><option>Dif√≠cil</option></select></div><div style="overflow-x:auto"><table id="tabela-questoes"><thead><tr><th width="40" onclick="ord('id')">ID</th><th width="90">Banca</th><th width="50">Ano</th><th width="100">Disc.</th><th>Enunciado</th><th width="100">Assunto</th><th width="50">Dif</th><th width="40">Gab</th><th width="60">A√ß√µes</th></tr></thead><tbody></tbody></table></div></div></section>
<section id="secao-flashcards" class="secao"><div class="container"><div class="flex" style="margin-bottom: 20px;"><h2>üóÇÔ∏è Flashcards</h2><div><button class="btn-acao" style="width:auto; background:#3498db; margin:0 5px" onclick="toggleModeFC('estudo')">üéì Modo Estudo</button><button class="btn-acao" style="width:auto; background:#95a5a6; margin:0" onclick="toggleModeFC('gerenciar')">‚úèÔ∏è Gerenciar</button></div></div><div id="fc-modo-gerenciar" style="display:none"><div class="fc-layout"><div><h4>Cart√µes Existentes</h4><input type="text" id="fc-filtro-ger" placeholder="Filtrar por texto..." onkeyup="renderListaFC()"><div id="fc-lista" class="fc-lista"></div></div><div style="background:#fafafa; padding:20px; border-radius:8px; border:1px solid #eee"><h4 id="fc-titulo-form">Novo Cart√£o</h4><form id="fc-form"><input type="hidden" id="fc-id"><label>Disciplina:</label><select id="fc-disciplina" required onchange="carregarAssuntos('fc')"></select><label>Assunto:</label><select id="fc-assunto" required></select><label>Frente (Pergunta):</label><textarea id="fc-frente" rows="3" class="input-com-toolbar" required onfocus="showToolbar(this)"></textarea><label>Verso (Resposta):</label><textarea id="fc-verso" rows="4" class="input-com-toolbar" required onfocus="showToolbar(this)"></textarea><div class="flex" style="margin-top:10px"><button type="button" class="btn-acao" style="background:#95a5a6; width:auto" onclick="limparFormFC()">Cancelar</button><button type="submit" class="btn-acao" style="width:auto">Salvar Cart√£o</button></div></form></div></div></div><div id="fc-modo-estudo" style="display:none"><div class="filtro-grid" style="justify-content:center; max-width:800px; margin:0 auto"><select id="fc-estudo-disc" onchange="carregarAssuntos('fc-estudo')"></select><select id="fc-estudo-assunto"><option value="">Todos Assuntos</option></select><button class="btn-acao" style="margin:5px 0" onclick="iniciarEstudoFC()">Iniciar Revis√£o</button></div><div id="fc-area-jogo" style="display:none; text-align:center"><h3 id="fc-progresso"></h3><div class="flip-card-container" id="card-ativo" onclick="virarCarta()"><div class="flip-card-inner"><div class="flip-card-front"><span class="fc-tag" id="fc-front-tag"></span><div id="fc-front-content"></div><span style="font-size:0.8rem; color:#999; margin-top:20px">(Clique para virar)</span></div><div class="flip-card-back"><div id="fc-back-content"></div></div></div></div><div id="fc-botoes" class="fc-botoes-resposta"><button class="btn-acao" style="background:#e74c3c; width:120px" onclick="respFC(false)">Errei üòì</button><button class="btn-acao" style="background:#27ae60; width:120px" onclick="respFC(true)">Acertei ü§©</button></div></div></div></div></section>
<section id="secao-praticar" class="secao"><div class="container" style="max-width:900px"><h2>Praticar</h2><div id="config-pratica"><div class="filtro-grid"><select id="prat-disciplina" onchange="carregarAssuntos('prat')"></select><select id="prat-assunto"><option value="">Todos Assuntos</option></select><select id="prat-banca"><option value="">Todas as Bancas</option></select><input type="number" id="prat-qtd" value="10" placeholder="Qtd"></div><button class="btn-acao" onclick="iniciarPratica()">Come√ßar Pr√°tica</button></div><div id="area-pratica" style="display:none"><div class="flex"><h3 id="prat-progresso"></h3><button onclick="cancelarPratica()" style="background:#e74c3c; border:none; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;">Sair</button></div><div class="questao-card"><div class="info-questao" id="prat-meta"></div><div class="enunciado render-html" id="prat-enunciado"></div><div id="prat-alternativas"></div></div><button id="prat-btn-confirma" class="btn-acao" onclick="confirmaPratica()">Confirmar</button><button id="prat-btn-prox" class="btn-acao" onclick="proxPratica()" style="display:none">Pr√≥xima</button><div id="prat-feedback" style="margin-top:15px; font-weight:bold; padding:10px; border-radius:4px;"></div></div></div></section>
<section id="secao-prova" class="secao"><div class="container" style="max-width:900px"><h2>Simulado Real</h2><div id="config-prova"><div class="filtro-grid"><div><label>Total:</label><input type="number" id="prova-total" value="10" min="1" onchange="prepProva();"></div><div><label>Tempo (min):</label><input type="number" id="prova-tempo" value="30" min="1"></div></div><div id="lista-distribuicao" style="background:#f9f9f9; padding:10px; border-radius:6px; margin-bottom:10px;"></div><div id="total-porc" style="text-align:right; font-weight:bold;">Total: 0%</div><button class="btn-acao" onclick="iniciarProva()">Iniciar Prova</button></div><div id="area-prova" style="display:none"><div id="barra-tempo-container"><div id="barra-tempo-fill"></div></div><div class="flex"><h3 id="prova-progresso"></h3><span id="prova-timer" style="font-weight:bold; color:var(--acc)">00:00</span></div><div class="questao-card"><div class="info-questao" id="prova-meta"></div><div class="enunciado render-html" id="prova-enunciado"></div><div id="prova-alternativas"></div></div><button class="btn-acao" onclick="proxProva()">Pr√≥xima / Finalizar</button></div><div id="resultado-prova" style="display:none; text-align:center;"><h2>Resultado</h2><div style="font-size:3em; font-weight:bold; color:var(--primary)" id="nota-prova"></div><p id="msg-prova"></p><div id="detalhes-prova" style="text-align:left; margin-top:20px;"></div><button class="btn-acao" onclick="prepProva(); nav('prova');">Novo Simulado</button></div></div></section>
<section id="secao-estatisticas" class="secao"><div class="container" style="max-width:900px"><h2>Desempenho</h2><canvas id="chart"></canvas></div></section>
<section id="secao-config" class="secao"><div class="container"><h2>Gerenciar Metadados</h2><div class="filtro-grid" style="margin-bottom:20px"><button class="btn-acao" style="background:#3498db; margin:0" onclick="mostrarConfig('disciplinas')">Disciplinas</button><button class="btn-acao" style="background:#3498db; margin:0" onclick="mostrarConfig('assuntos')">Assuntos</button><button class="btn-acao" style="background:#3498db; margin:0" onclick="mostrarConfig('bancas')">Bancas</button><button class="btn-acao" style="background:#3498db; margin:0" onclick="mostrarConfig('instituicoes')">Institui√ß√µes</button></div><div id="painel-config" style="background:#f9f9f9; padding:20px; border-radius:8px;"><h3 id="titulo-config">Selecione uma categoria acima</h3><div class="flex" style="gap:10px; margin-bottom:10px"><select id="cfg-disc-select" style="display:none; max-width:200px"></select><input type="number" id="cfg-ordem" placeholder="Ord." style="display:none; max-width:60px"><input type="text" id="cfg-novo-nome" placeholder="Nome do novo item..."><button id="cfg-btn-acao" class="btn-acao" style="width:auto; margin:0" onclick="addMeta()">Adicionar</button></div><div id="lista-meta-conteudo" class="lista-meta"></div></div></div></section>

<div id="modal-edicao" class="modal"><div class="modal-content"><span class="close-modal" onclick="el('modal-edicao').style.display='none'">&times;</span><h2>Editar</h2><form id="form-edicao"><input type="hidden" id="edit-id">
<label>Enunciado:</label><textarea id="edit-enunciado" class="input-com-toolbar" rows="3" required onfocus="showToolbar(this)"></textarea>
<label>Imagem:</label>
<div style="display:flex; align-items:center; gap:10px;">
    <input type="file" id="edit-imagem-file" accept="image/*">
    <div id="edit-img-preview-container"></div>
</div>
<input type="hidden" id="edit-imagem-nome">
<div class="filtro-grid"><select id="edit-banca"></select><select id="edit-instituicao"></select><input type="number" id="edit-ano" placeholder="Ano"><select id="edit-disciplina" onchange="carregarAssuntos('edit')"></select></div><div class="filtro-grid"><select id="edit-assunto"></select><select id="edit-dificuldade"><option>F√°cil</option><option>M√©dio</option><option>Dif√≠cil</option></select></div><select id="edit-tipo" onchange="altTipo('edit')"><option value="ME">M√∫ltipla</option><option value="CE">Certo/Errado</option></select><div id="edit-container-alt"><div class="input-group"><span>A)</span><input type="text" id="edit-alt-a" onfocus="showToolbar(this)"></div><div class="input-group"><span>B)</span><input type="text" id="edit-alt-b" onfocus="showToolbar(this)"></div><div class="input-group"><span>C)</span><input type="text" id="edit-alt-c" onfocus="showToolbar(this)"></div><div class="input-group"><span>D)</span><input type="text" id="edit-alt-d" onfocus="showToolbar(this)"></div><div class="input-group"><span>E)</span><input type="text" id="edit-alt-e" onfocus="showToolbar(this)"></div></div><label>Gabarito:</label><select id="edit-gabarito"></select><button class="btn-acao" style="background:#f39c12">Salvar</button></form></div></div>

<script>
const API = "http://localhost:5000";
let db=[], meta={}, foco=null, ordCol={c:null,d:'asc'};
let pratPool=[], pratIdx=0, pratAcertos=0;
let provaPool=[], provaIdx=0, provaRespostas=[], provaTempoTotal=0, provaIntervalo=null;
let flashDb=[], flashPool=[], flashIdx=0;
let checkDupTimeout = null; 

const el = id => document.getElementById(id);
const header = el("main-header");
let headerOffset = 0;

const nav = n => { 
    document.querySelectorAll('.secao').forEach(s=>s.style.display='none'); 
    el(`secao-${n}`).style.display='block'; 
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('ativa'));
    el(`nav-${n}`).classList.add('ativa');
    if(n==='banco') carrTab(); if(n==='praticar') prepPratica(); if(n==='prova') prepProva(); 
    if(n==='estatisticas') graf(); if(n==='flashcards') initFC();
    el("floating-toolbar").style.display = "none";
    window.scrollTo(0,0); 
};

const showLoader = (txt) => { el("loader-msg").innerText = txt; el("loader-overlay").style.display = "flex"; }
const hideLoader = () => { el("loader-overlay").style.display = "none"; }

const fmt = (elem, t) => { 
    let c = typeof elem === 'string' ? el(elem) : elem; if(!c) return;
    let s = c.selectionStart, e = c.selectionEnd;
    c.value = c.value.substring(0, s) + `<${t}>` + c.value.substring(s, e) + `</${t}>` + c.value.substring(e);
};
const fmtUlt = (t) => { if(foco) fmt(foco, t); };
function showToolbar(elem) {
    foco = elem; const tb = el('floating-toolbar');
    const rect = elem.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
    tb.style.top = (rect.top + scrollTop - 40) + 'px';
    tb.style.left = (rect.left + scrollLeft) + 'px';
    tb.style.display = 'flex';
}
document.addEventListener('click', function(e) {
    if (!e.target.closest('input') && !e.target.closest('textarea') && !e.target.closest('.floating-toolbar')) {
        el('floating-toolbar').style.display = 'none';
    }
});

async function init() {
    try {
        let [r1, r2, r3] = await Promise.all([fetch(`${API}/questoes`), fetch(`${API}/metadados`), fetch(`${API}/flashcards`)]);
        db = await r1.json(); meta = await r2.json(); flashDb = await r3.json();
        popSelGeral(); altTipo('cad'); nav('cadastro');
    } catch(e) { alert("Erro ao carregar dados. Verifique o servidor."); }
}
function popSelGeral() {
    ['cad','busca','edit','prat','prova','imp','fc','fc-estudo'].forEach(p => {
        if(el(`${p}-banca`)) pop(el(`${p}-banca`), meta.bancas, p==='imp'?"Banca Padr√£o...":"Banca...");
        if(el(`${p}-instituicao`)) pop(el(`${p}-instituicao`), meta.instituicoes, "Institui√ß√£o...");
        
        // Corre√ß√£o do ID espec√≠fico da aba de estudo
        let idDisc = (p === 'fc-estudo') ? 'fc-estudo-disc' : `${p}-disciplina`;
        if(el(idDisc)) pop(el(idDisc), meta.disciplinas, "Disciplina...");
    });
}
function pop(sel, arr, def) {
    if(!sel) return;
    let html = def ? `<option value="">${def}</option>` : "";
    if (arr && arr.length > 0) {
        arr.forEach(x => html += `<option>${x}</option>`);
    }
    sel.innerHTML = html;
}
// Otimiza a renderiza√ß√£o (evita piscar/bugar ao carregar muitas op√ß√µes)
function pop(sel, arr, def) {
    if(!sel) return;
    let html = def ? `<option value="">${def}</option>` : "";
    if (arr && arr.length > 0) {
        arr.forEach(x => html += `<option>${x}</option>`);
    }
    sel.innerHTML = html;
}

// Corrige os IDs, especificamente o 'fc-estudo-disc' que estava quebrando
function popSelGeral() {
    ['cad','busca','edit','prat','prova','imp','fc','fc-estudo'].forEach(p => {
        if(el(`${p}-banca`)) pop(el(`${p}-banca`), meta.bancas, p==='imp'?"Banca Padr√£o...":"Banca...");
        if(el(`${p}-instituicao`)) pop(el(`${p}-instituicao`), meta.instituicoes, "Institui√ß√£o...");
        
        // Corre√ß√£o do ID espec√≠fico da aba de estudo
        let idDisc = (p === 'fc-estudo') ? 'fc-estudo-disc' : `${p}-disciplina`;
        if(el(idDisc)) pop(el(idDisc), meta.disciplinas, "Disciplina...");
    });
}

// Corrige a leitura do valor da disciplina para carregar os assuntos
function carregarAssuntos(prefixo) {
    // Mapeamento correto do ID da disciplina
    let idDisc = (prefixo === 'fc-estudo') ? 'fc-estudo-disc' : `${prefixo}-disciplina`;
    let elDisc = el(idDisc);
    let selAss = el(`${prefixo}-assunto`);
    
    if (!elDisc || !selAss) return;

    let disc = elDisc.value;
    let html = '<option value="">Todos Assuntos</option>';
    
    if (meta.assuntos) {
        let lista = meta.assuntos.filter(a => a.disciplina === disc);
        lista.forEach(a => { 
            html += `<option value="${a.nome}">${a.ordem || ''}. ${a.nome}</option>`; 
        });
    }
    selAss.innerHTML = html;
}

// --- IMPORTA√á√ÉO PDF ---
async function lerPDF() {
    let lista = el("imp-lista-questoes");
    if (lista && lista.children.length > 0) {
        if(!confirm("‚ö†Ô∏è ATEN√á√ÉO: Voc√™ j√° tem quest√µes importadas. Ler novo PDF substituir√° a lista atual.")) return;
    }
    let inp = el("imp-file"); if(inp.files.length === 0) return alert("Selecione um arquivo PDF");
    let fd = new FormData(); fd.append("file", inp.files[0]);
    el("imp-preview-container").style.display = "none"; el("imp-lista-questoes").innerHTML = "";
    showLoader("Lendo e Processando PDF...");
    try {
        let r = await fetch(`${API}/upload-pdf`, { method:"POST", body:fd }); if(!r.ok) throw new Error();
        let questoes = await r.json(); renderPreview(questoes);
    } catch(e) { alert("Erro ao ler PDF."); el("imp-lista-questoes").innerHTML = ""; } finally { hideLoader(); }
}

function renderPreview(lista) {
    let div = el("imp-lista-questoes"); div.innerHTML = "";
    el("imp-titulo-preview").innerText = `Pr√©via (${lista.length} encontradas)`;
    el("imp-preview-container").style.display = "block";
    
    lista.forEach((q, i) => {
        let statusHtml = q.ja_cadastrada ? `<span class="aviso-dup">‚ö†Ô∏è J√° Cadastrada</span>` : "";
        let classeRow = q.ja_cadastrada ? "imp-row ja-cadastrada" : "imp-row";
        let btnDisabled = q.ja_cadastrada ? "disabled style='opacity:0.5'" : "";
        let optionsGab = `<option value="">?</option>`;
        ["A","B","C","D","E"].forEach(l => { let sel = q.gabarito === l ? "selected" : ""; optionsGab += `<option value="${l}" ${sel}>${l}</option>`; });
        
        div.innerHTML += `
        <div class="${classeRow}" id="imp-row-${i}">
            <div style="width:40px; font-weight:bold; text-align:center">
                ${i+1}
                <div id="status-${i}">${statusHtml}</div>
            </div>
            <div class="imp-meta">
                <input type="text" class="imp-banca" placeholder="Banca" value="${q.banca}">
                <input type="text" class="imp-inst" placeholder="Institui√ß√£o" value="${q.instituicao}" style="font-size:0.85em">
                <input type="number" class="imp-ano" placeholder="Ano" value="${q.ano}">
                <input type="text" class="imp-assunto-ind" placeholder="Assunto" value="${q.assunto}" style="font-size:0.85em; color:var(--purple)">
                <select class="imp-dif"><option value="M√©dio">M√©dio</option><option value="F√°cil">F√°cil</option><option value="Dif√≠cil">Dif√≠cil</option></select>
            </div>
            <div class="imp-content">
                <textarea class="imp-textarea imp-enunciado" rows="3" placeholder="Enunciado" onfocus="showToolbar(this)" oninput="verificarDuplicidadeDinamica(${i})">${q.enunciado}</textarea>
                <div style="margin: 5px 0;">
                    <label style="font-size:0.8em; color:#666">Anexar Imagem:</label>
                    <input type="file" class="imp-imagem-file" accept="image/*" style="font-size:0.8em">
                </div>
                <div style="margin-top:5px; display:grid; gap:5px">
                    <div class="input-group"><span>A)</span><input type="text" class="imp-alt-a" value="${q.alt_a}" onfocus="showToolbar(this)" oninput="verificarDuplicidadeDinamica(${i})"></div>
                    <div class="input-group"><span>B)</span><input type="text" class="imp-alt-b" value="${q.alt_b}" onfocus="showToolbar(this)" oninput="verificarDuplicidadeDinamica(${i})"></div>
                    <div class="input-group"><span>C)</span><input type="text" class="imp-alt-c" value="${q.alt_c}" onfocus="showToolbar(this)" oninput="verificarDuplicidadeDinamica(${i})"></div>
                    <div class="input-group"><span>D)</span><input type="text" class="imp-alt-d" value="${q.alt_d}" onfocus="showToolbar(this)" oninput="verificarDuplicidadeDinamica(${i})"></div>
                    <div class="input-group"><span>E)</span><input type="text" class="imp-alt-e" value="${q.alt_e}" onfocus="showToolbar(this)" oninput="verificarDuplicidadeDinamica(${i})"></div>
                </div>
            </div>
            <div class="imp-gab"><select class="imp-gabarito">${optionsGab}</select></div>
            <div class="imp-acoes">
                <button id="btn-save-${i}" class="btn-icon" style="color:#27ae60" onclick="salvarIndividual(${i})" title="Salvar" ${btnDisabled}>üíæ</button>
                <button class="btn-icon" style="color:red" onclick="el('imp-row-${i}').remove()">‚úñ</button>
            </div>
        </div>`;
    });
}

function verificarDuplicidadeDinamica(index) {
    clearTimeout(checkDupTimeout);
    checkDupTimeout = setTimeout(async () => {
        let row = el(`imp-row-${index}`);
        
        // Agora pega TUDO
        let payload = {
            enunciado: row.querySelector(".imp-enunciado").value,
            alt_a: row.querySelector(".imp-alt-a").value,
            alt_b: row.querySelector(".imp-alt-b").value,
            alt_c: row.querySelector(".imp-alt-c").value,
            alt_d: row.querySelector(".imp-alt-d").value,
            alt_e: row.querySelector(".imp-alt-e").value
        };
        
        if (!payload.enunciado) return;

        try {
            const resp = await fetch(`${API}/check-duplicidade`, {
                method: "POST", headers: { "Content-Type": "application/json" }, 
                body: JSON.stringify(payload)
            });
            const data = await resp.json();
            let statusDiv = el(`status-${index}`), btnSave = el(`btn-save-${index}`);
            if (data.existe) {
                statusDiv.innerHTML = `<span class="aviso-dup">‚ö†Ô∏è J√° Cadastrada</span>`;
                row.classList.add("ja-cadastrada");
                btnSave.disabled = true; btnSave.style.opacity = "0.5";
            } else {
                statusDiv.innerHTML = "";
                row.classList.remove("ja-cadastrada");
                btnSave.disabled = false; btnSave.style.opacity = "1";
            }
        } catch(e) { console.error("Erro check dup", e); }
    }, 500);
}

async function salvarIndividual(index) {
    let r = el(`imp-row-${index}`);
    let disc = el("imp-disciplina").value;
    if(!disc) return alert("Selecione a Disciplina base (acima da lista) antes de salvar.");

    let assuntoFinal = r.querySelector(".imp-assunto-ind").value || el("imp-assunto").value;
    if(!assuntoFinal) assuntoFinal = "Geral";

    const formData = new FormData();
    formData.append("banca", r.querySelector(".imp-banca").value);
    formData.append("instituicao", r.querySelector(".imp-inst").value);
    formData.append("ano", r.querySelector(".imp-ano").value);
    formData.append("dificuldade", r.querySelector(".imp-dif").value);
    formData.append("enunciado", r.querySelector(".imp-enunciado").value);
    formData.append("alt_a", r.querySelector(".imp-alt-a").value);
    formData.append("alt_b", r.querySelector(".imp-alt-b").value);
    formData.append("alt_c", r.querySelector(".imp-alt-c").value);
    formData.append("alt_d", r.querySelector(".imp-alt-d").value);
    formData.append("alt_e", r.querySelector(".imp-alt-e").value);
    formData.append("gabarito", r.querySelector(".imp-gabarito").value);
    formData.append("tipo", "ME");
    formData.append("disciplina", disc);
    formData.append("assunto", assuntoFinal);

    // Captura imagem
    const fileInput = r.querySelector(".imp-imagem-file");
    if(fileInput && fileInput.files[0]) {
        formData.append("imagem_file", fileInput.files[0]);
    }

    if(!formData.get("enunciado") || !formData.get("gabarito")) return alert("Enunciado e Gabarito s√£o obrigat√≥rios.");

    try {
        const response = await fetch(`${API}/questoes`, { method: "POST", body: formData });
        if (response.status === 200 || response.status === 201) {
            r.classList.remove("ja-cadastrada");
            r.classList.add("sucesso-salvo");
            r.querySelector(".imp-acoes").innerHTML = `<span style="color:green; font-weight:bold">Salva!</span> <button class="btn-icon" style="color:red" onclick="el('imp-row-${index}').remove()">‚úñ</button>`;
        } else if (response.status === 409) {
            alert("Esta quest√£o j√° existe no banco!");
            verificarDuplicidadeDinamica(index);
        } else { alert("Erro ao salvar."); }
    } catch(e) { alert("Erro de conex√£o."); }
}

async function salvarLote() {
    // Nota: O salvamento em lote em JSON n√£o suporta imagens. Imagens devem ser salvas individualmente ou precisaria converter tudo para FormData loopado
    let rows = document.querySelectorAll(".imp-row"); let disc = el("imp-disciplina").value; let assGlobal = el("imp-assunto").value;
    if(!disc) return alert("Selecione a Disciplina base (acima da lista).");
    
    // Filtra apenas quest√µes sem imagem para lote JSON, ou avisa
    let lote = [];
    rows.forEach(r => {
        if(r.classList.contains("sucesso-salvo") || r.classList.contains("ja-cadastrada")) return; 
        
        // Verifica se tem imagem anexada, se tiver, avisa que deve salvar individualmente
        if(r.querySelector(".imp-imagem-file").files.length > 0) return;

        let assuntoFinal = r.querySelector(".imp-assunto-ind").value || assGlobal || "Geral";
        let obj = {
            banca: r.querySelector(".imp-banca").value, instituicao: r.querySelector(".imp-inst").value, 
            ano: r.querySelector(".imp-ano").value, dificuldade: r.querySelector(".imp-dif").value,
            enunciado: r.querySelector(".imp-enunciado").value,
            alt_a: r.querySelector(".imp-alt-a").value, alt_b: r.querySelector(".imp-alt-b").value, alt_c: r.querySelector(".imp-alt-c").value, alt_d: r.querySelector(".imp-alt-d").value, alt_e: r.querySelector(".imp-alt-e").value,
            gabarito: r.querySelector(".imp-gabarito").value, tipo: "ME", disciplina: disc, assunto: assuntoFinal
        };
        if(obj.enunciado && obj.gabarito) lote.push(obj);
    });

    if(lote.length === 0) return alert("Nenhuma quest√£o nova (sem imagem) para salvar em lote. Para quest√µes com imagem, use o bot√£o de salvar individual.");
    
    if(!confirm(`Tentar salvar ${lote.length} quest√µes (sem imagens) em lote?`)) return;
    showLoader("Salvando quest√µes...");
    let contadores = { salvos: 0, erros: 0 };
    for(let q of lote) {
        try {
            const response = await fetch(`${API}/questoes`, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(q) });
            if (response.ok) contadores.salvos++; else contadores.erros++;
        } catch(e) { contadores.erros++; }
    }
    hideLoader();
    alert(`Finalizado!\n‚úÖ Salvas: ${contadores.salvos}\n‚ùå Erros: ${contadores.erros}`);
    if(contadores.salvos > 0) { init(); }
}

// Configura√ß√µes e Inicializa√ß√£o
window.onscroll = function() { if (window.scrollY > headerOffset) { header.classList.add("sticky"); document.body.classList.add("header-espaco"); } else { header.classList.remove("sticky"); document.body.classList.remove("header-espaco"); } };
function initFC() { toggleModeFC('estudo'); }
function toggleModeFC(modo) { el("fc-modo-gerenciar").style.display = modo === 'gerenciar' ? 'block' : 'none'; el("fc-modo-estudo").style.display = modo === 'estudo' ? 'block' : 'none'; if(modo === 'gerenciar') renderListaFC(); }
function renderListaFC() { let div = el("fc-lista"), filtro = el("fc-filtro-ger").value.toLowerCase(); div.innerHTML = ""; flashDb.filter(f => f.frente.toLowerCase().includes(filtro) || f.verso.toLowerCase().includes(filtro)).forEach(f => { div.innerHTML += `<div class="fc-item-lista"><div style="flex-grow:1" onclick="editarFC('${f.id}')"><div style="font-weight:bold; font-size:0.85em; color:var(--sec)">${f.disciplina} > ${f.assunto}</div><div>${f.frente.substring(0,40)}...</div></div><button class="btn-icon" style="color:red" onclick="delFC('${f.id}')">‚úñ</button></div>`; }); }
function editarFC(id) { let f = flashDb.find(x => String(x.id) === String(id)); if(!f) return; el("fc-id").value = f.id; el("fc-disciplina").value = f.disciplina; carregarAssuntos('fc'); el("fc-assunto").value = f.assunto; el("fc-frente").value = f.frente; el("fc-verso").value = f.verso; el("fc-titulo-form").innerText = "Editar Cart√£o"; }
function limparFormFC() { el("fc-form").reset(); el("fc-id").value=""; el("fc-titulo-form").innerText = "Novo Cart√£o"; }
async function delFC(id) { if(confirm("Excluir Flashcard?")) { await fetch(`${API}/flashcards/${id}`, {method:"DELETE"}); flashDb = await (await fetch(`${API}/flashcards`)).json(); renderListaFC(); } }
el("fc-form").onsubmit = async e => { e.preventDefault(); let obj = { id: el("fc-id").value, disciplina: el("fc-disciplina").value, assunto: el("fc-assunto").value, frente: el("fc-frente").value, verso: el("fc-verso").value }; let method = obj.id ? "PUT" : "POST"; await fetch(`${API}/flashcards`, {method:method, headers:{"Content-Type":"application/json"}, body:JSON.stringify(obj)}); flashDb = await (await fetch(`${API}/flashcards`)).json(); limparFormFC(); renderListaFC(); alert("Salvo!"); };
function iniciarEstudoFC() { let disc = el("fc-estudo-disc").value, ass = el("fc-estudo-assunto").value; flashPool = flashDb.filter(f => (disc===""||f.disciplina===disc) && (ass===""||f.assunto===ass)); if(flashPool.length === 0) return alert("Nenhum cart√£o encontrado."); flashPool = flashPool.sort(() => 0.5 - Math.random()); flashIdx = 0; el("fc-area-jogo").style.display="block"; renderCard(); }
function renderCard() { if(flashIdx >= flashPool.length) { el("fc-area-jogo").style.display="none"; return alert("Revis√£o Conclu√≠da!"); } let c = flashPool[flashIdx]; el("fc-progresso").innerText = `Cart√£o ${flashIdx+1} de ${flashPool.length}`; el("fc-front-tag").innerText = `${c.disciplina} > ${c.assunto}`; el("fc-front-content").innerHTML = c.frente.replace(/\n/g, "<br>"); el("fc-back-content").innerHTML = c.verso.replace(/\n/g, "<br>"); el("card-ativo").classList.remove("virado"); el("fc-botoes").classList.remove("visivel"); }
function virarCarta() { el("card-ativo").classList.toggle("virado"); if(el("card-ativo").classList.contains("virado")) el("fc-botoes").classList.add("visivel"); }
async function respFC(acertou) { let c = flashPool[flashIdx]; c[acertou ? 'acertos' : 'erros']++; await fetch(`${API}/flashcards`, {method:"PUT", headers:{"Content-Type":"application/json"}, body:JSON.stringify(c)}); flashIdx++; renderCard(); }
let catAtual = "", editandoMeta = null;
function mostrarConfig(cat) { catAtual = cat; cancelarEdicaoMeta(); el("titulo-config").innerText = "Gerenciando: " + cat.toUpperCase(); let isAssunto = cat === 'assuntos'; el("cfg-disc-select").style.display = isAssunto ? "block" : "none"; el("cfg-ordem").style.display = isAssunto ? "block" : "none"; if(isAssunto) pop(el("cfg-disc-select"), meta.disciplinas, "Escolha a Disciplina"); renderListaMeta(); }
function renderListaMeta() { let div = el("lista-meta-conteudo"); div.innerHTML = ""; let lista = meta[catAtual] || []; if(catAtual === 'assuntos') { lista.forEach(item => { let itemJson = JSON.stringify(item).replace(/"/g, '&quot;'); div.innerHTML += `<div class="item-meta"><span>[${item.disciplina}] ${item.ordem}. <b>${item.nome}</b></span><div><button class="btn-icon" style="color:#f39c12; margin-right:5px" onclick="iniciarEdicaoMeta(${itemJson})">‚úèÔ∏è</button><button class="btn-icon" style="color:#e74c3c" onclick="delMeta('${item.nome}')">‚úñ</button></div></div>`; }); } else { lista.forEach(item => { div.innerHTML += `<div class="item-meta"><span>${item}</span><div><button class="btn-icon" style="color:#f39c12; margin-right:5px" onclick="iniciarEdicaoMeta('${item}')">‚úèÔ∏è</button><button class="btn-icon" style="color:#e74c3c" onclick="delMeta('${item}')">‚úñ</button></div></div>`; }); } }
function iniciarEdicaoMeta(dado) { el("cfg-btn-acao").innerText = "Salvar Altera√ß√£o"; el("cfg-btn-acao").style.background = "#f39c12"; if(catAtual === 'assuntos') { editandoMeta = dado.nome; el("cfg-novo-nome").value = dado.nome; el("cfg-disc-select").value = dado.disciplina; el("cfg-ordem").value = dado.ordem; } else { editandoMeta = dado; el("cfg-novo-nome").value = dado; } el("cfg-novo-nome").focus(); }
function cancelarEdicaoMeta() { editandoMeta = null; el("cfg-novo-nome").value = ""; el("cfg-ordem").value = ""; if (catAtual === 'assuntos' && el("cfg-disc-select").options.length > 0) el("cfg-disc-select").value = el("cfg-disc-select").options[0].value; el("cfg-btn-acao").innerText = "Adicionar"; el("cfg-btn-acao").style.background = ""; }
async function addMeta() { let nome = el("cfg-novo-nome").value; if(!nome) return alert("Digite um nome"); let novoItem = { nome: nome }; if(catAtual === 'assuntos') { let disc = el("cfg-disc-select").value, ord = el("cfg-ordem").value; if(!disc) return alert("Para assuntos, selecione a disciplina."); novoItem.disciplina = disc; novoItem.ordem = ord ? parseInt(ord) : null; } try { let payload = editandoMeta ? { antigo: editandoMeta, novo: novoItem } : novoItem; let method = editandoMeta ? "PUT" : "POST"; await fetch(`${API}/metadados/${catAtual}`, { method: method, headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) }); let r = await fetch(`${API}/metadados`); meta = await r.json(); cancelarEdicaoMeta(); renderListaMeta(); popSelGeral(); } catch (e) { alert("Erro ao salvar metadado."); } }
async function delMeta(nome) { if(!confirm(`Excluir ${nome} de ${catAtual}?`)) return; await fetch(`${API}/metadados/${catAtual}?nome=${encodeURIComponent(nome)}`, {method:"DELETE"}); let r = await fetch(`${API}/metadados`); meta = await r.json(); renderListaMeta(); popSelGeral(); }
function altTipo(p) { let t = el(`${p}-tipo`).value, d = el(`${p}-container-alt`), s = el(`${p}-gabarito`); s.innerHTML=""; if(t==="ME"){ d.style.display="block"; ["A","B","C","D","E"].forEach(l=>s.innerHTML+=`<option value="${l}">${l}</option>`); } else { d.style.display="none"; s.innerHTML=`<option value="C">Certo</option><option value="E">Errado</option>`; } }

// CADASTRO MANUAL (FormData)
el("form-cadastro").onsubmit = async e => { 
    e.preventDefault(); 
    const formData = new FormData();
    formData.append("banca", el("cad-banca").value); formData.append("instituicao", el("cad-instituicao").value); formData.append("ano", el("cad-ano").value);
    formData.append("enunciado", el("cad-enunciado").value); formData.append("disciplina", el("cad-disciplina").value); formData.append("assunto", el("cad-assunto").value);
    formData.append("dificuldade", el("cad-dificuldade").value); formData.append("tipo", el("cad-tipo").value); formData.append("gabarito", el("cad-gabarito").value);
    formData.append("alt_a", el("cad-alt-a").value); formData.append("alt_b", el("cad-alt-b").value); formData.append("alt_c", el("cad-alt-c").value); formData.append("alt_d", el("cad-alt-d").value); formData.append("alt_e", el("cad-alt-e").value);
    
    let fileInput = el("cad-imagem"); if(fileInput.files[0]) formData.append("imagem_file", fileInput.files[0]);

    try { 
        const r = await fetch(`${API}/questoes`, {method:"POST", body: formData}); 
        if(r.status === 409) return alert("Quest√£o duplicada!"); 
        if(r.ok) { alert("Salvo!"); e.target.reset(); fileInput.value=""; altTipo("cad"); init(); } else throw new Error(); 
    } catch(err) { alert("Erro ao salvar."); } 
};

function carrTab() { el("total-db").innerText = `${db.length} quest√µes`; filtrar(); }
function filtrar() { let txt=el("busca-texto").value.toLowerCase(), ban=el("busca-banca").value, dis=el("busca-disciplina").value, ass=el("busca-assunto").value, dif=el("busca-dificuldade").value; let filtrados = db.filter(q => q.enunciado.toLowerCase().includes(txt) && (ban===""||q.banca===ban) && (dis===""||q.disciplina===dis) && (ass===""||q.assunto===ass) && (dif===""||q.dificuldade===dif)); let tb = document.querySelector("#tabela-questoes tbody"); tb.innerHTML=""; filtrados.forEach(q => { let difClass = q.dificuldade==='F√°cil'?'color-facil':(q.dificuldade==='M√©dio'?'color-medio':'color-dificil'); let dots = q.dificuldade==='F√°cil'?'‚óè':(q.dificuldade==='M√©dio'?'‚óè‚óè':'‚óè‚óè‚óè'); tb.innerHTML += `<tr><td>${q.id}</td><td>${q.banca}</td><td>${q.ano||'-'}</td><td>${q.disciplina}</td><td title="${q.enunciado.replace(/"/g,'&quot;')}">${q.enunciado.substring(0,40)}...</td><td>${q.assunto}</td><td style="text-align:center"><span class="dots ${difClass}">${dots}</span></td><td>${q.gabarito}</td><td><button class="btn-icon" onclick="abrirEd('${q.id}')">‚úèÔ∏è</button><button class="btn-icon" onclick="del('${q.id}')">üóëÔ∏è</button></td></tr>`; }); }
function del(id) { if(confirm("Excluir Quest√£o?")) fetch(`${API}/questoes/${id}`, {method:"DELETE"}).then(init); }
function ord(c) { ordCol.d = (ordCol.c===c && ordCol.d==='asc') ? 'desc':'asc'; ordCol.c=c; aplOrd(); filtrar(); }
function aplOrd() { let {c,d} = ordCol; let m = d==='asc'?1:-1; db.sort((a,b) => { let va=a[c]?a[c].toString().toLowerCase():"", vb=b[c]?b[c].toString().toLowerCase():""; if(c==='id'){ va=parseInt(a[c]); vb=parseInt(b[c]); } return va<vb ? -1*m : (va>vb ? 1*m : 0); }); }

function abrirEd(id) { 
    let q = db.find(x=>String(x.id)===String(id)); if(!q)return; 
    el("edit-id").value=q.id; el("edit-enunciado").value=q.enunciado; el("edit-assunto").value=q.assunto; el("edit-instituicao").value=q.instituicao||""; el("edit-ano").value=q.ano||""; el("edit-dificuldade").value=q.dificuldade; el("edit-tipo").value=q.tipo; el("edit-banca").value=q.banca; el("edit-disciplina").value=q.disciplina; carregarAssuntos('edit'); el("edit-assunto").value=q.assunto; altTipo("edit"); 
    if(q.tipo==="ME"){ el("edit-alt-a").value=q.alt_a||""; el("edit-alt-b").value=q.alt_b||""; el("edit-alt-c").value=q.alt_c||""; el("edit-alt-d").value=q.alt_d||""; el("edit-alt-e").value=q.alt_e||""; } el("edit-gabarito").value=q.gabarito; 
    
    // Imagem Edi√ß√£o
    el("edit-imagem-nome").value = q.imagem || "";
    el("edit-imagem-file").value = "";
    let prev = el("edit-img-preview-container");
    prev.innerHTML = q.imagem ? `<a href="${API}/img/q_img/${q.imagem}" target="_blank"><img src="${API}/img/q_img/${q.imagem}" class="img-preview-mini"></a>` : "<span style='font-size:0.8em;color:#999'>Sem imagem</span>";

    el("modal-edicao").style.display="block"; 
}

el("form-edicao").onsubmit = async e => { 
    e.preventDefault(); 
    const formData = new FormData();
    formData.append("id", el("edit-id").value); formData.append("banca", el("edit-banca").value); formData.append("instituicao", el("edit-instituicao").value); formData.append("ano", el("edit-ano").value);
    formData.append("enunciado", el("edit-enunciado").value); formData.append("disciplina", el("edit-disciplina").value); formData.append("assunto", el("edit-assunto").value);
    formData.append("dificuldade", el("edit-dificuldade").value); formData.append("tipo", el("edit-tipo").value); formData.append("gabarito", el("edit-gabarito").value);
    formData.append("alt_a", el("edit-alt-a").value); formData.append("alt_b", el("edit-alt-b").value); formData.append("alt_c", el("edit-alt-c").value); formData.append("alt_d", el("edit-alt-d").value); formData.append("alt_e", el("edit-alt-e").value);
    
    formData.append("imagem", el("edit-imagem-nome").value);
    let fileInput = el("edit-imagem-file"); if(fileInput.files[0]) formData.append("imagem_file", fileInput.files[0]);

    await fetch(`${API}/questoes`, {method:"PUT", body: formData}); 
    el("modal-edicao").style.display="none"; init(); 
};

function prepPratica() { el("config-pratica").style.display="block"; el("area-pratica").style.display="none"; }
function iniciarPratica() { let dis=el("prat-disciplina").value, ban=el("prat-banca").value, ass=el("prat-assunto").value, qtd=el("prat-qtd").value; let pool = db.filter(q => (dis===""||q.disciplina===dis) && (ban===""||q.banca===ban) && (ass===""||q.assunto===ass)); if(pool.length===0) return alert("Nenhuma quest√£o encontrada"); pratPool = pool.sort(()=>0.5-Math.random()).slice(0, qtd); pratIdx = 0; pratAcertos = 0; el("config-pratica").style.display="none"; el("area-pratica").style.display="block"; renPratica(); }
function renPratica() { 
    let q = pratPool[pratIdx]; 
    el("prat-progresso").innerText = `Quest√£o ${pratIdx+1} de ${pratPool.length}`; 
    el("prat-meta").innerHTML = `<b>${q.banca}</b> (${q.ano||'-'}) | ${q.instituicao||'-'} | ${q.disciplina} > ${q.assunto}`; 
    
    let htmlImg = q.imagem ? `<img src="${API}/img/q_img/${q.imagem}" class="questao-img">` : "";
    el("prat-enunciado").innerHTML = htmlImg + q.enunciado; 
    
    let div = el("prat-alternativas"); div.innerHTML=""; if(q.tipo==="CE"){ radio(div,"C","Certo","prat"); radio(div,"E","Errado","prat"); } else ["A","B","C","D","E"].forEach(l=>{ if(q[`alt_${l.toLowerCase()}`]) radio(div,l,q[`alt_${l.toLowerCase()}`],"prat"); }); el("prat-feedback").innerHTML=""; el("prat-feedback").style.background="transparent"; el("prat-btn-confirma").style.display="block"; el("prat-btn-prox").style.display="none"; 
}
function radio(d,v,t,n) { d.innerHTML+=`<div class="alternativa-wrapper" onclick="selecionarAlternativa(this, '${n}', '${v}')"><span class="btn-riscar" onclick="event.stopPropagation();this.parentElement.classList.toggle('riscado-ativo')">‚úñ</span><input type="radio" name="${n}" value="${v}" style="margin:0 10px; pointer-events:none"><span class="render-html">${v}) ${t}</span></div>`; }
function selecionarAlternativa(elWrapper, name, val) { document.querySelectorAll(`input[name='${name}']`).forEach(i => i.checked = false); document.querySelectorAll(`#area-${name} .alternativa-wrapper`).forEach(e => e.classList.remove("selected")); elWrapper.classList.add("selected"); elWrapper.querySelector("input").checked = true; if(name === 'prova') provaRespostas[provaIdx] = val; }
function confirmaPratica() { let s=document.querySelector('input[name="prat"]:checked'); if(!s) return alert("Selecione"); let q=pratPool[pratIdx], acertou=s.value===q.gabarito, f=el("prat-feedback"); f.innerHTML = acertou ? "Correto! ‚úÖ" : `Errado! ‚ùå Gabarito: ${q.gabarito}`; f.style.background = acertou ? "#d4edda" : "#f8d7da"; if(acertou) { pratAcertos++; } let qOriginal = db.find(d => d.id === q.id); if (qOriginal) { qOriginal.respondidas = (qOriginal.respondidas || 0) + 1; if (acertou) qOriginal.acertos = (qOriginal.acertos || 0) + 1; fetch(`${API}/questoes`, {method:"PUT", headers:{"Content-Type":"application/json"}, body:JSON.stringify(qOriginal)}); } el("prat-btn-confirma").style.display="none"; el("prat-btn-prox").style.display="block"; }
function proxPratica() { pratIdx++; if(pratIdx<pratPool.length) renPratica(); else { alert(`Fim! Acertos: ${pratAcertos}/${pratPool.length}`); nav('praticar'); } }
function cancelarPratica() { if(confirm("Sair?")) nav('praticar'); }
function prepProva() { el("resultado-prova").style.display="none"; let dis=meta.disciplinas, div=el("lista-distribuicao"); div.innerHTML=""; dis.forEach(d => { div.innerHTML += `<div class="config-row" style="display:flex; gap:10px; align-items:center;"><label>${d}:</label><input type="number" class="inp-dist" data-disc="${d}" value="0" min="0" max="100" onchange="calcDistribuicao()" style="width:60px"> %</div>`; }); calcDistribuicao(); }
function calcDistribuicao() { let total=0; document.querySelectorAll(".inp-dist").forEach(i => total += parseInt(i.value||0)); el("total-porc").innerText = `Total: ${total}%`; el("total-porc").style.color = total===100 ? "green" : "red"; }
function iniciarProva() { let totalPerc=0; document.querySelectorAll(".inp-dist").forEach(i => totalPerc += parseInt(i.value||0)); if(totalPerc!==100) return alert("A soma das porcentagens deve ser 100%"); let qtdTotal = parseInt(el("prova-total").value); provaTempoTotal = parseInt(el("prova-tempo").value) * 60; provaPool = []; document.querySelectorAll(".inp-dist").forEach(i => { let perc = parseInt(i.value||0); if(perc > 0) { let disc = i.dataset.disc; let qtdDisc = Math.round((perc/100) * qtdTotal); let questoesDisc = db.filter(q => q.disciplina === disc).sort(()=>0.5-Math.random()).slice(0, qtdDisc); provaPool = provaPool.concat(questoesDisc); } }); if(provaPool.length === 0) return alert("Nenhuma quest√£o dispon√≠vel."); provaPool = provaPool.sort(()=>0.5-Math.random()); provaIdx = 0; provaRespostas = []; el("config-prova").style.display="none"; el("area-prova").style.display="block"; el("barra-tempo-container").style.display="block"; iniciarTimer(); renProva(); }
function iniciarTimer() { let tempoRestante = provaTempoTotal; if(provaIntervalo) clearInterval(provaIntervalo); provaIntervalo = setInterval(() => { tempoRestante--; let min = Math.floor(tempoRestante/60), sec = tempoRestante%60; el("prova-timer").innerText = `${min}:${sec<10?'0'+sec:sec}`; el("barra-tempo-fill").style.width = `${(tempoRestante/provaTempoTotal)*100}%`; if(tempoRestante <= 0) { clearInterval(provaIntervalo); finalizarProva(); } }, 1000); }
function renProva() { 
    let q = provaPool[provaIdx]; 
    el("prova-progresso").innerText = `Quest√£o ${provaIdx+1} de ${provaPool.length}`; 
    el("prova-meta").innerText = `${q.banca} (${q.ano||'-'}) | ${q.instituicao||'-'} | ${q.disciplina} > ${q.assunto}`; 
    let htmlImg = q.imagem ? `<img src="${API}/img/q_img/${q.imagem}" class="questao-img">` : "";
    el("prova-enunciado").innerHTML = htmlImg + q.enunciado; 
    let div = el("prova-alternativas"); div.innerHTML=""; let respSalva = provaRespostas[provaIdx] || null; if(q.tipo==="CE"){ radioProva(div,"C","Certo", respSalva); radioProva(div,"E","Errado", respSalva); } else ["A","B","C","D","E"].forEach(l=>{ if(q[`alt_${l.toLowerCase()}`]) radioProva(div,l,q[`alt_${l.toLowerCase()}`], respSalva); }); 
}
function radioProva(div, val, txt, selecionado) { let cls = selecionado === val ? "selected" : ""; div.innerHTML += `<div class="alternativa-wrapper ${cls}" onclick="selecionarAlternativa(this, 'prova', '${val}')"><span class="btn-riscar" onclick="event.stopPropagation();this.parentElement.classList.toggle('riscado-ativo')">‚úñ</span><input type="radio" name="prova" value="${val}" ${selecionado === val ? 'checked' : ''} style="margin:0 10px; pointer-events:none"><span class="render-html">${val}) ${txt}</span></div>`; }
function proxProva() { provaIdx++; if(provaIdx < provaPool.length) { renProva(); } else { if(confirm("Finalizar Prova?")) finalizarProva(); else provaIdx--; } }
function finalizarProva() { clearInterval(provaIntervalo); el("area-prova").style.display="none"; el("resultado-prova").style.display="block"; let acertos = 0; let html = "<ul style='list-style:none; padding:0'>"; let acertosPorDisc = {}; provaPool.forEach((q, i) => { let resp = provaRespostas[i], correta = q.gabarito, isCorrect = resp === correta; if(isCorrect) acertos++; if (!acertosPorDisc[q.disciplina]) acertosPorDisc[q.disciplina] = { total: 0, acertos: 0 }; acertosPorDisc[q.disciplina].total++; if (isCorrect) acertosPorDisc[q.disciplina].acertos++; let realQ = db.find(d => d.id === q.id); if(realQ) { realQ.respondidas = (realQ.respondidas || 0) + 1; if(isCorrect) realQ.acertos = (realQ.acertos || 0) + 1; fetch(`${API}/questoes`, {method:"PUT", headers:{"Content-Type":"application/json"}, body:JSON.stringify(realQ)}); } html += `<li style="margin-bottom:10px; border-bottom:1px solid #eee; padding:5px;"><b>Q${i+1} (${q.disciplina}):</b> Sua: <b style="color:${isCorrect?'green':'red'}">${resp||'-'}</b> | Gab: <b>${correta}</b></li>`; }); let discHtml = '<h3>Desempenho por Disciplina</h3><ul style="list-style:none; padding:0;">'; for (const disc in acertosPorDisc) { let stats = acertosPorDisc[disc]; let perc = (stats.acertos / stats.total) * 100; discHtml += `<li style="margin-bottom:5px;"><b>${disc}:</b> ${stats.acertos} / ${stats.total} (${perc.toFixed(1)}%)</li>`; } discHtml += '</ul>'; el("nota-prova").innerText = `${acertos}/${provaPool.length}`; el("msg-prova").innerText = acertos/provaPool.length >= 0.7 ? "Aprovado! üöÄ" : "Continue Estudando üìö"; el("detalhes-prova").innerHTML = discHtml + html; init(); }
function graf() { let ctx=el("chart").getContext("2d"); if(window.myChart)window.myChart.destroy(); let stats={}; db.forEach(q=>{ if(!stats[q.disciplina]) stats[q.disciplina]={r:0,a:0}; stats[q.disciplina].r+=q.respondidas; stats[q.disciplina].a+=q.acertos; }); let l=[], d=[], c=[]; for(let k in stats){ if(stats[k].r>0){ l.push(k); let p=(stats[k].a/stats[k].r)*100; d.push(p.toFixed(1)); c.push(p>=50?'#27ae60':'#e74c3c'); } } window.myChart=new Chart(ctx,{type:'bar',data:{labels:l,datasets:[{label:'%',data:d,backgroundColor:c}]},options:{scales:{y:{beginAtZero:true,max:100}}}}); }
function setupDragDrop() { const dropZone = el("area-drop"); const fileInput = el("imp-file"); ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { dropZone.addEventListener(eventName, preventDefaults, false); }); function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); } ['dragenter', 'dragover'].forEach(eventName => { dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false); }); ['dragleave', 'drop'].forEach(eventName => { dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false); }); dropZone.addEventListener('drop', handleDrop, false); function handleDrop(e) { let dt = e.dataTransfer; let files = dt.files; if (files.length > 0) { fileInput.files = files; } } }
window.onload = () => { init(); headerOffset = el('secao-cadastro').offsetTop; setupDragDrop(); };
</script>
</body>
</html>